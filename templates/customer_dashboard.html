{% extends "base.html" %}
{% block title %}Customer Dashboard{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">Customer Dashboard</h1>
    <p class="text-gray-600 mb-6">Welcome, {{ customer['name'] }} (Email: {{ customer['email'] }})</p>

    <!-- Mini Preview Windows Section -->
    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-8">
        <!-- My Flights Preview -->
        <div class="flex-1 bg-gray-100 p-4 rounded-lg shadow">
            <a href="{{ url_for('customer_flights') }}" class="text-blue-600 hover:underline">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">My Flights</h3>
            </a>
            <div class="text-sm text-gray-600">
                {% if flights %}
                    <p class="mb-2"><em>Your upcoming flights. Click title for full list.</em></p>
                    <div class="space-y-3">
                        {% for flight in flights %}
                            <div class="bg-white p-3 rounded-md shadow-sm">
                                <p class="font-semibold">{{ flight['airline_name'] }} Flight #{{ flight['flight_num'] }}</p>
                                <p>{{ flight['departure_airport'] }} to {{ flight['arrival_airport'] }}</p>
                                <p>Time: {{ flight['departure_time'] }} - Status: <span class="font-medium">{{ flight['status'] }}</span></p>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>You have no upcoming flights.</p>
                    <p><em>Click title to see flight history.</em></p>
                {% endif %}
            </div>
        </div>

        <!-- Track My Spending Preview -->
        <div class="flex-1 bg-gray-100 p-4 rounded-lg shadow">
            <a href="{{ url_for('customer_spending') }}" class="text-blue-600 hover:underline">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">My Spending</h3>
            </a>
            <div class="text-sm text-gray-600">
                <p class="mb-1">A summary of your spending.</p>
                <p class="mb-3"><em>Click title for detailed spending.</em></p>
                {% if monthly_spending %}
                    <canvas id="spendingChart" width="100" height="50" class="mt-6"></canvas>
                    <script>
                        const months = {{ monthly_spending | map(attribute='month') | list | tojson }};
                        const spent = {{ monthly_spending | map(attribute='spent') | list | tojson }};

                        new Chart(document.getElementById('spendingChart').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                            label: 'Spent',
                            data: spent,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true } } }
                        });
                    </script>
                {% else %}
                    <p>No spending data available yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Available Flights Section -->
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Available Flights</h2>
    <div class="space-y-4">
        {% if flights %}
            {% for flight in flights %}
                <div class="bg-white p-4 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="mb-2 sm:mb-0">
                        <p class="text-lg font-semibold">{{ flight['airline_name'] }} Flight #{{ flight['flight_num'] }}</p>
                        <p class="text-gray-600">{{ flight['departure_airport'] }} to {{ flight['arrival_airport'] }}</p>
                        <p class="text-gray-600">Departs at: {{ flight['departure_time'] }}</p>
                        <p class="text-gray-600">Price: ${{ flight['price'] }}</p>
                        <p class="text-blue-600">Seats Left: {{ flight['seats_left'] }}</p>
                    </div>
                    <form method="POST" action="{{ url_for('purchase_ticket', airline_name=flight['airline_name'], flight_num=flight['flight_num']) }}" class="w-full sm:w-auto">
                        <button type="submit" class="w-full sm:w-auto bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">Purchase</button>
                    </form>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-gray-600">No flights available at the moment. Please check back later.</p>
        {% endif %}
    </div>
</div>
{% endblock %}